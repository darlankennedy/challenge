# 80 → redireciona tudo para HTTPS
server {
    listen 80;
    server_name ec2-98-86-111-21.compute-1.amazonaws.com;
    return 301 https://$host$request_uri;
}

# 443 com TLS
server {
    listen 443 ssl http2;
    server_name ec2-98-86-111-21.compute-1.amazonaws.com;

    # Certs vindos do volume ssl-certs
    ssl_certificate     /certs/cert.pem;
    ssl_certificate_key /certs/key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    # Se quiser redirecionar somente a raiz para /graphiql:
    location = / {
        return 301 /graphiql;
    }

    root /backend/public;
    index index.php index.html;

    location / {
        try_files $uri /index.php?$query_string;
    }

    # PHP-FPM (use o nome do serviço correto!)
    location ~ \.php$ {
        include fastcgi_params;  # em alpine, pode usar 'fastcgi.conf' também
        fastcgi_pass app-php:9000;  # se seu serviço PHP tem container_name: app-php
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 300;
    }

    location ~ /\. { deny all; }
}
